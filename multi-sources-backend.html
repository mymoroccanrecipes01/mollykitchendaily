<!-- multi-sources.php - VERSION BACKEND -->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>G√©n√©rateur Multi-Sources (Backend)</title>
    <style>
        .multi-source-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .left-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        .right-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        .source-count-selector {
            margin-bottom: 20px;
        }
        
        .source-count-selector label {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .source-count-selector select {
            padding: 8px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .sources-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
            background: white;
        }
        
        .sources-table th,
        .sources-table td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        
        .sources-table th {
            background: #4CAF50;
            color: white;
            font-weight: bold;
        }
        
        .sources-table input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .sources-table .status {
            text-align: center;
            font-weight: bold;
        }
        
        .status.pending { color: #999; }
        .status.processing { color: #2196F3; }
        .status.success { color: #4CAF50; }
        .status.error { color: #f44336; }
        
        .control-buttons {
            margin: 20px 0;
            text-align: center;
        }
        
        .control-buttons button {
            padding: 12px 30px;
            margin: 0 10px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-primary:hover {
            background: #45a049;
        }
        
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #0b7dda;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        .btn-primary:disabled,
        .btn-secondary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .progress-info {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        
        .log-info { color: #2196F3; }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #ff9800; }
        
        .session-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
        
        .session-info strong {
            color: #1976D2;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="multi-source-container">
    <h2>üöÄ G√©n√©rateur Multi-Sources (Backend Complet + AI Images)</h2>
    <p style="color: #666; margin-top: 10px;">
        ‚ú® Traitement automatique: OpenAI ‚Üí AI Images ‚Üí Download ‚Üí WebP ‚Üí Pinterest ‚Üí Database ‚Üí Index/RSS
    </p>
    
    <div id="sessionInfo" class="session-info" style="display: none;">
        <strong>üîë Session ID:</strong> <span id="sessionId"></span><br>
        <strong>üìä Progression:</strong> <span id="sessionProgress">0/0</span>
    </div>
    
    <div class="main-layout">
        <!-- Panneau gauche: Contr√¥les -->
        <div class="left-panel">
            <!-- S√©lecteur de nombre de sources -->
            <div class="source-count-selector">
                <label for="sourceCount">Nombre de sources :</label>
                <select id="sourceCount" onchange="generateTable()">
                    <option value="5">5 sources</option>
                    <option value="10" selected>10 sources</option>
                    <option value="15">15 sources</option>
                    <option value="20">20 sources</option>
                    <option value="25">25 sources</option>
                    <option value="30">30 sources</option>
                </select>
            </div>
            
            <!-- Tableau des sources -->
            <table class="sources-table" id="sourcesTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>URL ou texte de la source</th>
                        <th style="width: 120px;">Statut</th>
                    </tr>
                </thead>
                <tbody id="sourceTableBody">
                    <!-- G√©n√©r√© par JS -->
                </tbody>
            </table>
            
            <!-- Boutons de contr√¥le -->
            <div class="control-buttons">
                <button id="startBtn" class="btn-primary" onclick="startProcessing()">
                    ‚ñ∂Ô∏è D√©marrer le traitement
                </button>
                <button id="stopBtn" class="btn-danger" onclick="stopProcessing()" disabled>
                    ‚è∏Ô∏è Arr√™ter
                </button>
                <button id="resetBtn" class="btn-secondary" onclick="resetAll()">
                    üîÑ R√©initialiser
                </button>
            </div>
            
            <!-- Progression -->
            <div class="progress-info" id="progressInfo">
                En attente...
            </div>
        </div>
        
        <!-- Panneau droit: Logs -->
        <div class="right-panel">
            <h3>üìã Journal d'activit√©</h3>
            <div class="log-container" id="logContainer">
                <!-- Logs g√©n√©r√©s par JS -->
            </div>
        </div>
    </div>
</div>

<script>
// Configuration
const CONFIG = {
    apiUrl: 'api-complete.php', // API compl√®te qui fait TOUT
    delayBetweenSources: 3000, // 3 secondes entre chaque source
    pollingInterval: 2000 // V√©rifier le statut toutes les 2 secondes
};

// √âtat global
let sources = [];
let isProcessing = false;
let currentIndex = 0;
let sessionId = null;
let pollingTimer = null;

// Ajouter un log
function addLog(message, type = 'info') {
    const container = document.getElementById('logContainer');
    const entry = document.createElement('div');
    entry.className = `log-entry log-${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    container.appendChild(entry);
    container.scrollTop = container.scrollHeight;
}

// Mettre √† jour le statut d'une source
function updateStatus(index, status, message) {
    const cell = document.getElementById(`status_${index}`);
    if (cell) {
        cell.className = `status ${status}`;
        cell.textContent = message;
    }
}

// Mettre √† jour la progression
function updateProgress() {
    const completed = sources.filter(s => s.status === 'success' || s.status === 'error').length;
    const total = sources.filter(s => s.text !== '').length;
    
    document.getElementById('progressInfo').textContent = 
        `Progression: ${completed}/${total} sources trait√©es`;
    
    document.getElementById('sessionProgress').textContent = `${completed}/${total}`;
}

// G√©n√©rer le tableau
function generateTable() {
    const count = parseInt(document.getElementById('sourceCount').value);
    sources = Array(count).fill(null).map((_, i) => ({
        text: '',
        status: 'pending'
    }));
    
    const tbody = document.getElementById('sourceTableBody');
    tbody.innerHTML = '';
    
    for (let i = 0; i < count; i++) {
        const row = tbody.insertRow();
        
        const cellNum = row.insertCell(0);
        cellNum.textContent = i + 1;
        cellNum.style.textAlign = 'center';
        
        const cellInput = row.insertCell(1);
        const input = document.createElement('input');
        input.type = 'text';
        input.id = `source_${i + 1}`;
        input.placeholder = `Entrez l'URL ou le texte de la source ${i + 1}`;
        cellInput.appendChild(input);
        
        const cellStatus = row.insertCell(2);
        cellStatus.id = `status_${i}`;
        cellStatus.className = 'status pending';
        cellStatus.textContent = 'En attente';
    }
    
    addLog(`Tableau g√©n√©r√©: ${count} sources`, 'info');
}

// Appel API
async function callAPI(action, data = {}) {
    try {
        const formData = new FormData();
        formData.append('action', action);
        
        for (const [key, value] of Object.entries(data)) {
            if (typeof value === 'object') {
                formData.append(key, JSON.stringify(value));
            } else {
                formData.append(key, value);
            }
        }
        
        const response = await fetch(CONFIG.apiUrl, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Unknown error');
        }
        
        return result;
        
    } catch (error) {
        addLog(`Erreur API (${action}): ${error.message}`, 'error');
        throw error;
    }
}

// Initialiser la session
async function initSession() {
    // R√©cup√©rer les sources
    sources.forEach((source, index) => {
        const input = document.getElementById(`source_${index + 1}`);
        source.text = input.value.trim();
    });
    
    const validSources = sources.filter(s => s.text !== '').map(s => s.text);
    
    if (validSources.length === 0) {
        alert('‚ùå Aucune source valide trouv√©e!');
        return null;
    }
    
    addLog(`üîÑ Initialisation de la session avec ${validSources.length} sources...`, 'info');
    
    const result = await callAPI('init', { sources: validSources });
    
    sessionId = result.session_id;
    document.getElementById('sessionInfo').style.display = 'block';
    document.getElementById('sessionId').textContent = sessionId;
    
    addLog(`‚úÖ Session cr√©√©e: ${sessionId}`, 'success');
    
    // Retourner les donn√©es avec le count
    return {
        ...result.data,
        validSourcesCount: validSources.length
    };
}

// Traiter une source
async function processSource(index) {
    addLog(`üì§ Envoi source ${index + 1} au backend pour traitement COMPLET...`, 'info');
    addLog(`   ‚Üí G√©n√©ration recipe (OpenAI)`, 'info');
    addLog(`   ‚Üí G√©n√©ration images AI (genimg.php)`, 'info');
    addLog(`   ‚Üí T√©l√©chargement images`, 'info');
    addLog(`   ‚Üí Conversion WebP`, 'info');
    addLog(`   ‚Üí Template Pinterest`, 'info');
    addLog(`   ‚Üí Sauvegarde database`, 'info');
    addLog(`   ‚Üí G√©n√©ration index/sitemap/RSS`, 'info');
    updateStatus(index, 'processing', '‚è≥ Traitement complet...');
    
    try {
        const result = await callAPI('process', {
            session_id: sessionId,
            source_index: index
        });
        
        if (result.success) {
            updateStatus(index, 'success', '‚úÖ Termin√©');
            addLog(`‚úÖ Source ${index + 1} - Recipe cr√©√©e: ${result.data.slug}`, 'success');
            addLog(`   üìä Titre: ${result.data.title}`, 'success');
            addLog(`   üñºÔ∏è Images: ${result.data.images_count}`, 'success');
            return true;
        } else {
            updateStatus(index, 'error', '‚ùå Erreur');
            addLog(`‚ùå Source ${index + 1}: ${result.error}`, 'error');
            return false;
        }
        
    } catch (error) {
        updateStatus(index, 'error', '‚ùå Erreur');
        addLog(`‚ùå Source ${index + 1}: ${error.message}`, 'error');
        return false;
    }
}

// V√©rifier le statut de la session
async function checkSessionStatus() {
    if (!sessionId) return;
    
    try {
        const result = await callAPI('status', { session_id: sessionId });
        const data = result.data;
        
        // Mettre √† jour les statuts
        data.sources.forEach((source, index) => {
            if (sources[index]) {
                sources[index].status = source.status;
                
                let statusText = '';
                switch(source.status) {
                    case 'pending': statusText = 'En attente'; break;
                    case 'processing': statusText = '‚è≥ En cours...'; break;
                    case 'completed': statusText = '‚úÖ Termin√©'; break;
                    case 'error': statusText = '‚ùå Erreur'; break;
                }
                
                updateStatus(index, source.status, statusText);
            }
        });
        
        updateProgress();
        
        // Si tout est termin√©
        if (data.status === 'completed') {
            stopPolling();
            finishProcessing();
        }
        
    } catch (error) {
        addLog(`‚ö†Ô∏è Erreur v√©rification statut: ${error.message}`, 'warning');
    }
}

// D√©marrer le polling
function startPolling() {
    if (pollingTimer) {
        clearInterval(pollingTimer);
    }
    
    pollingTimer = setInterval(checkSessionStatus, CONFIG.pollingInterval);
    addLog('üëÄ Surveillance du statut activ√©e', 'info');
}

// Arr√™ter le polling
function stopPolling() {
    if (pollingTimer) {
        clearInterval(pollingTimer);
        pollingTimer = null;
        addLog('‚è∏Ô∏è Surveillance du statut arr√™t√©e', 'info');
    }
}

// D√©marrer le traitement
async function startProcessing() {
    // Nettoyer les logs
    document.getElementById('logContainer').innerHTML = '';
    
    // Initialiser la session
    const sessionData = await initSession();
    if (!sessionData) return;
    
    isProcessing = true;
    
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('resetBtn').disabled = true;
    
    addLog(`üöÄ D√©marrage du traitement COMPLET`, 'info');
    addLog(`üìä ${sessionData.validSourcesCount} sources √† traiter`, 'info');
    addLog(`‚è±Ô∏è Temps estim√©: ~${sessionData.validSourcesCount * 3.5} minutes`, 'info');
    addLog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
    
    // D√©marrer le polling
    startPolling();
    
    // Traiter les sources s√©quentiellement
    for (let i = 0; i < sources.length; i++) {
        if (!isProcessing) {
            addLog('‚è∏Ô∏è Traitement arr√™t√© par l\'utilisateur', 'warning');
            break;
        }
        
        if (sources[i].text) {
            currentIndex = i;
            updateProgress();
            
            await processSource(i);
            
            // Pause entre les sources
            if (i < sources.length - 1 && isProcessing) {
                addLog(`‚è≥ Pause de ${CONFIG.delayBetweenSources/1000}s...`, 'info');
                await new Promise(resolve => setTimeout(resolve, CONFIG.delayBetweenSources));
            }
        }
    }
}

// Terminer le traitement
function finishProcessing() {
    isProcessing = false;
    stopPolling();
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('resetBtn').disabled = false;
    
    // Statistiques finales
    const totalSources = sources.filter(s => s.text !== '').length;
    const successCount = sources.filter(s => s.status === 'success').length;
    const failedCount = sources.filter(s => s.status === 'error').length;
    
    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
    addLog(`üéâ TRAITEMENT TERMIN√â!`, 'success');
    addLog(`üìä R√©sum√©: ${successCount}/${totalSources} r√©ussies, ${failedCount} √©chou√©es`, 'info');
    addLog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
    
    updateProgress();
    
    // Notification sonore
    try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURA');
        audio.play().catch(() => {});
    } catch (e) {}
}

// Arr√™ter le traitement
function stopProcessing() {
    isProcessing = false;
    stopPolling();
    addLog('‚è∏Ô∏è Arr√™t demand√©...', 'warning');
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('resetBtn').disabled = false;
}

// R√©initialiser
function resetAll() {
    isProcessing = false;
    stopPolling();
    currentIndex = 0;
    sessionId = null;
    
    sources.forEach((source, index) => {
        updateStatus(index, 'pending', 'En attente');
    });
    
    document.getElementById('progressInfo').textContent = 'En attente...';
    document.getElementById('logContainer').innerHTML = '';
    document.getElementById('sessionInfo').style.display = 'none';
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    
    addLog('üîÑ Syst√®me r√©initialis√©', 'info');
}

// Initialiser
window.addEventListener('DOMContentLoaded', function() {
    generateTable();
    addLog('‚úÖ Syst√®me pr√™t - Backend Complet', 'success');
    addLog('üîß Traitement c√¥t√© serveur:', 'info');
    addLog('   ‚Ä¢ G√©n√©ration recipe via OpenAI', 'info');
    addLog('   ‚Ä¢ G√©n√©ration images AI via genimg.php', 'info');
    addLog('   ‚Ä¢ T√©l√©chargement automatique des images', 'info');
    addLog('   ‚Ä¢ Conversion WebP optimis√©e', 'info');
    addLog('   ‚Ä¢ Template Pinterest automatique', 'info');
    addLog('   ‚Ä¢ Sauvegarde compl√®te en database', 'info');
    addLog('   ‚Ä¢ Index, Sitemap & RSS g√©n√©r√©s', 'info');
    addLog('‚è±Ô∏è Temps estim√©: ~3-4 minutes par source', 'info');
});
</script>

</body>
</html>